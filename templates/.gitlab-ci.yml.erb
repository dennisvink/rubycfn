image: rubycfn/rubycfn:latest

before_script:
  - bundle

variables:
  CFN_ARTIFACT_BUCKET: "my-awesome-cloudformation-bucket"
  STAGING_AWS_REGION: eu-west-1
  PROD_AWS_REGION: eu-west-1

stages:
  - build
  - test
  - upload
  - staging
  - production

build:
  stage: build
  variables:
    ARTIFACT_BUCKET: ${CFN_ARTIFACT_BUCKET}
  script:
    - export SLACK_WEBHOOK=$K8S_SECRET_SLACK_POST_HOOK
    - ENVIRONMENT="test" rake compile
    - ENVIRONMENT="production" rake compile
    - rubocop
    - cfn_nag_scan --input-path build/ || true
  artifacts:
    paths:
      - build/

test:
  stage: test
  script: 
    - rake spec
  dependencies:
    - build

upload:
  stage: upload
  variables:
    ARTIFACT_BUCKET: ${CFN_ARTIFACT_BUCKET}
    AWS_REGION: ${STAGING_AWS_REGION}
  script:
    - export AWS_SECRET_ACCESS_KEY=$K8S_SECRET_AWS_SECRET_ACCESS_KEY
    - export AWS_ACCESS_KEY_ID=$K8S_SECRET_AWS_ACCESS_KEY_ID
    - ENVIRONMENT="test" rake upload
    - ENVIRONMENT="production" rake upload

deploy_staging:
  stage: staging
  variables:
    ARTIFACT_BUCKET: ${CFN_ARTIFACT_BUCKET}
    AWS_REGION: ${STAGING_AWS_REGION}
  script:
    - export AWS_SECRET_ACCESS_KEY=$K8S_SECRET_AWS_SECRET_ACCESS_KEY
    - export AWS_ACCESS_KEY_ID=$K8S_SECRET_AWS_ACCESS_KEY_ID
    - export ENVIRONMENT="test"
    - rake apply
  allow_failure: false

deploy_prod:
  stage: production
  variables:
    ARTIFACT_BUCKET: ${CFN_ARTIFACT_BUCKET}
    AWS_REGION: ${PROD_AWS_REGION}
  script:
    - export AWS_SECRET_ACCESS_KEY=$K8S_SECRET_AWS_SECRET_ACCESS_KEY
    - export AWS_ACCESS_KEY_ID=$K8S_SECRET_AWS_ACCESS_KEY_ID
    - export ENVIRONMENT="production"
    - rake apply
  dependencies:
    - deploy_staging
  when: manual
  allow_failure: false
